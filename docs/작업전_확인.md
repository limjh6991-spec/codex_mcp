# 작업 전 확인 체크리스트 (다음 세션 시작용)

## 1. 환경 / 실행 점검
- [ ] Python 버전 확인 (`python --version`) → 3.12.x 예상
- [ ] 로컬 실행 테스트: 
  ```bash
  python scripts/ipc_policy_gateway.py --port 45123 --deadline-ms 1.0 --deadline-escalate-threshold 3 --degrade-mode-ratio 0.5 --log-dir /tmp/gw_check
  ```
  - [ ] `[ipc_gateway] listening on 127.0.0.1:45123` 출력 확인
- [ ] 새 터미널에서 ping/obs 프로브:
  ```bash
  python - <<'PY'
import socket, json
s=socket.create_connection(("127.0.0.1",45123))
s.sendall(b'{"type":"ping"}\n')
print("PING:", s.recv(4096).decode().strip())
s.sendall(b'{"type":"obs","data":{"q":[0,1,2],"dq":[0,0,0]}}\n')
print("OBS :", s.recv(4096).decode().strip())
PY
  ```
  - [ ] action 응답 및 policy_unavailable 오류 없는지 (정책 미로딩 시 error 기대 가능)
- [ ] dummy policy 로딩 테스트:
  ```bash
  echo '{"type":"linear_dummy","action_dim":3}' > /tmp/dummy_policy.json
  python - <<'PY'
import socket, json
s=socket.create_connection(("127.0.0.1",45123))
msg={"type":"load_policy","path":"/tmp/dummy_policy.json"}
s.sendall((json.dumps(msg)+'\n').encode())
print("LOAD:", s.recv(4096).decode().strip())
PY
  ```

## 2. 테스트 실행
- [ ] 부분 테스트 (deadline escalation):
  ```bash
  pytest -k deadline_escalation -q
  ```
  기대: `1 passed`
- [ ] 전체 테스트:
  ```bash
  pytest -q
  ```
  기대: `25 passed, 5 skipped`

## 3. 핵심 기능 상태 (요약)
- Deadline escalation: 연속 miss → advisory 이벤트 + degrade 모드 가능
- Degrade zeroing: 확률적 zero 적용 시 `degrade_zeroed` 카운터 증가
- Joint spec mismatch: CLI 기반 cooldown (`--joint-spec-mismatch-cooldown`)
- Schema validation: jsonschema/fastjsonschema 사용 (스키마 없으면 graceful disable)
- Admin 명령: `flush_metrics`, `get_counters`
- Metrics: `ipc_metrics.json` 스냅샷 + Prometheus textfile(옵션)

## 4. 주요 카운터 정의
| 카운터 | 의미 |
|--------|------|
| deadline_miss | deadline 초과 횟수 |
| consec_deadline_miss | 현재 연속 deadline miss 누적 (성공 시 0 리셋) |
| deadline_escalation_events | 에스컬레이션 advisory 발생 횟수 |
| degrade_zeroed | degrade 모드로 delta zero 처리된 횟수 |
| joint_limit_violation | joint limit 클리핑된 joint index 누적합 |
| joint_spec_mismatch | 관측 q 크기 vs spec DOF 불일치 감지 횟수 |
| rand_hash_mismatch | 기대 rand hash vs 실제 불일치 횟수 |

## 5. 로그/메트릭 파일 경로 (기본)
- 이벤트 로그: `logs/ipc_gateway_events.jsonl`
- 메트릭: `logs/ipc_metrics.json`
- rand hash mismatch 로그: `logs/hash_mismatch_events.jsonl`

## 6. 다음 세션 추천 후속 작업 후보
- [ ] degrade zeroing 동작 전용 테스트 추가 (ratio=1.0 환경에서 검증)
- [ ] escalation advisory에 직전 consec 값 보강(`consec_before_reset`)
- [ ] Prometheus 메트릭에 degrade 비율 기반 파생 지표(예: zero_ratio) 계산 (옵션)
- [ ] 정책 미로딩 상태에서의 deadline pre-check fast path 추가 여부 재검토
- [ ] 성능 기준치(perf baseline) 재생성 여부 (최근 변경 후 영향 평가)

## 7. 빠른 수동 검증 시나리오
1. 게이트웨이 기동 (위 실행 예) 후 1ms deadline + overshoot 로직으로 deadline_miss 발생 확인.
2. 3회 이상 miss 유도 → 로그에서 `"type":"deadline_escalation"` 검색.
3. degrade_mode_ratio > 0 설정 후 여러 obs 반복 → `degrade_zeroed` 카운터 증가 확인.
4. joint spec 파일 작성 후 DOF mismatch 의도적으로 유도하여 advisory 발생 확인.

## 8. grep / 로그 검사 유틸
```bash
grep -n "deadline_escalation" logs/ipc_gateway_events.jsonl | tail
jq '.counters' logs/ipc_metrics.json
```

## 9. 문제 발생 시 빠른 초기 진단
| 증상 | 확인 포인트 |
|------|--------------|
| 서버 미기동 | 포트 충돌 / 파이썬 예외 (stdout/stderr) |
| schema_violation | 입력 JSON 구조 / 스키마 버전 필드 / fastjsonschema 설치 여부 |
| escalation 안 됨 | 연속 miss 조건 충족 여부 / overshoot sleep 적용 여부 |
| degrade_zeroed 0 유지 | ratio 값, escalation 후 degrade_mode 활성 여부 확인 |

---
(문서 자동 생성 시각: 최신 세션 종료 시)
